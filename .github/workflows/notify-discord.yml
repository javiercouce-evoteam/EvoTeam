name: Discord Notification

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GITHUB }}
        run: |
          EVENT_NAME="${{ github.event_name }}"

          if [ "$EVENT_NAME" = "pull_request" ]; then
            PR_ACTION="${{ github.event.action }}"
            PR_MERGED="${{ github.event.pull_request.merged }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_FROM="${{ github.head_ref }}"
            PR_TO="${{ github.base_ref }}"
            PR_COMMITS="${{ github.event.pull_request.commits }}"

            if [ "$PR_ACTION" = "opened" ]; then
              {
                echo "**$PR_TITLE**"
                echo
                echo "$PR_BODY"
              } | jq -Rs \
                --arg title "üîÄ Pull Request Abierta" \
                --arg url "$PR_URL" \
                --arg author "$PR_AUTHOR" \
                --arg from "$PR_FROM" \
                --arg to "$PR_TO" \
                --arg commits "$PR_COMMITS" \
                '{
                  embeds: [{
                    title: $title,
                    description: .,
                    url: $url,
                    color: 5814783,
                    fields: [
                      { name: "Autor", value: $author, inline: true },
                      { name: "Rama origen ‚Üí destino", value: "\($from) ‚Üí \($to)", inline: true },
                      { name: "Commits", value: $commits, inline: true }
                    ]
                  }]
                }' | curl -H "Content-Type: application/json" -X POST -d @- $DISCORD_WEBHOOK
            elif [ "$PR_ACTION" = "closed" ] && [ "$PR_MERGED" = "true" ]; then
              jq -n \
                --arg title "üéâ Pull Request Mergeada" \
                --arg url "$PR_URL" \
                --arg author "$PR_AUTHOR" \
                --arg from "$PR_FROM" \
                --arg to "$PR_TO" \
                '{
                  embeds: [{
                    title: $title,
                    description: "üöÄ \($from) ‚Üí \($to)\nüßë Autor: \($author)",
                    url: $url,
                    color: 15844367
                  }]
                }' | curl -H "Content-Type: application/json" -X POST -d @- $DISCORD_WEBHOOK
            fi

          elif [ "$EVENT_NAME" = "push" ]; then
            REPO="${{ github.repository }}"
            AUTHOR="${{ github.actor }}"
            REF="${{ github.ref_name }}"
            COMMITS=$(jq -c '.commits[]' "$GITHUB_EVENT_PATH")

            {
              echo "üßë Autor: \`$AUTHOR\`"
              echo "üîÅ Rama: \`$REF\`"
              echo "üì¶ Commits:"
              while IFS= read -r commit; do
                MESSAGE=$(echo $commit | jq -r '.message')
                URL=$(echo $commit | jq -r '.url')
                SHA=$(echo $commit | jq -r '.id' | cut -c1-7)
                echo "‚Ä¢ [\`$SHA\`]($URL) $MESSAGE"
              done <<< "$COMMITS"
            } | jq -Rs --arg title "üì¶ Push a $REF" '{
              embeds: [{
                title: $title,
                description: .,
                color: 3066993
              }]
            }' | curl -H "Content-Type: application/json" -X POST -d @- $DISCORD_WEBHOOK
          fi
