name: Discord Notification

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, closed, reopened, synchronize]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GITHUB }}
        run: |
          EVENT_NAME="${{ github.event_name }}"

          if [ "$EVENT_NAME" = "pull_request" ]; then
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_ACTION="${{ github.event.action }}"
            PR_FROM="${{ github.head_ref }}"
            PR_TO="${{ github.base_ref }}"
            PR_COMMITS="${{ github.event.pull_request.commits }}"

            curl -H "Content-Type: application/json" -X POST -d "{
              \"content\": null,
              \"embeds\": [
                {
                  \"title\": \"üîÄ Pull Request ${PR_ACTION^^}\",
                  \"description\": \"**${PR_TITLE}**\n\n${PR_BODY}\",
                  \"url\": \"${PR_URL}\",
                  \"color\": 5814783,
                  \"fields\": [
                    { \"name\": \"Autor\", \"value\": \"${PR_AUTHOR}\", \"inline\": true },
                    { \"name\": \"Rama origen ‚Üí destino\", \"value\": \"${PR_FROM} ‚Üí ${PR_TO}\", \"inline\": true },
                    { \"name\": \"Commits\", \"value\": \"${PR_COMMITS}\", \"inline\": true }
                  ]
                }
              ]
            }" $DISCORD_WEBHOOK

          elif [ "$EVENT_NAME" = "push" ]; then
            REPO="${{ github.repository }}"
            AUTHOR="${{ github.actor }}"
            REF="${{ github.ref_name }}"
            COMMITS=$(jq -c '.commits[]' "$GITHUB_EVENT_PATH")

            DESCRIPTION="üßë Autor: \`${AUTHOR}\`\nüîÅ Rama: \`${REF}\`\nüì¶ Commits:\n"

            while IFS= read -r commit; do
              MESSAGE=$(echo $commit | jq -r '.message')
              URL=$(echo $commit | jq -r '.url')
              SHA=$(echo $commit | jq -r '.id' | cut -c1-7)
              DESCRIPTION="${DESCRIPTION}‚Ä¢ [\`${SHA}\`](${URL}) ${MESSAGE}\n"
            done <<< "$COMMITS"
